# Just configuration file for running commands.
#
# For more information, visit https://just.systems.

set script-interpreter := ["nu"]
set shell := ["nu", "--commands"]
set unstable := true
set windows-shell := ["nu", "--commands"]
export PATH := if os() == "windows" {
  justfile_dir() / ".vendor/bin;" + justfile_dir() / ".vendor/cargo/bin;" + 
  env("Path")
} else {
  justfile_dir() / ".vendor/bin:" + justfile_dir() / ".vendor/cargo/bin:" + 
  env("PATH")
}

# List all commands available in justfile.
list:
  @just --list

# Execute CI workflow commands.
ci: setup lint doc build test

# Build distribution package.
build:
  cargo build

# Wrapper to Cargo.
[no-exit-message]
@cargo *args:
  cargo {{ "{{" }}args{{ "}}" }}

# Build documentation.
[script]
doc:
  cargo doc

# Fix code formatting.
format:
  {% if cookiecutter.project_prettier -%}
  deno run --allow-all npm:prettier --write .
  {% endif -%}
  cargo fmt -- --check

# Install project programs.
[script]
install: build
  python3 -m pip install (ls build/dist/*.whl | get name | first)

# Run code analyses.
lint:
  {% if cookiecutter.project_prettier -%}
  deno run --allow-all npm:prettier --check .
  {% endif -%}
  cargo fmt -- --check

# Install development dependencies.
[script]
setup: _setup
  {% if cookiecutter.project_prettier -%}
  if (which deno | is-empty) {
    http get https://scruffaluff.github.io/picoware/install/deno.nu
    | nu -c $"($in | decode); main --preserve-env --dest .vendor/bin"
  }
  deno --version
  {% endif -%}
  if (which cargo | is-empty) {
    http get https://scruffaluff.github.io/picoware/install/cargo.nu
    | nu -c $"($in | decode); main --preserve-env --dest .vendor/cargo"
  }
  cargo --version
  if (which rust-script | is-empty) {
    http get https://scruffaluff.github.io/picoware/install/rust-script.nu
    | nu -c $"($in | decode); main --preserve-env --dest .vendor/bin"
  }
  rust-script --version

[unix]
_setup:
  #!/usr/bin/env sh
  set -eu
  if [ ! -x "$(command -v nu)" ]; then
    curl --fail --location --show-error \
      https://scruffaluff.github.io/picoware/install/nushell.sh | sh -s -- \
      --preserve-env --dest .vendor/bin
  fi
  echo "Nushell $(nu --version)"

[windows]
_setup:
  #!powershell.exe
  $ErrorActionPreference = 'Stop'
  $ProgressPreference = 'SilentlyContinue'
  $PSNativeCommandUseErrorActionPreference = $True
  if (-not (Get-Command -ErrorAction SilentlyContinue nu)) {
    $NushellScript = Invoke-WebRequest -UseBasicParsing -Uri `
      https://scruffaluff.github.io/picoware/install/nushell.ps1
    Invoke-Expression "& { $NushellScript } --preserve-env --dest .vendor/bin"
  }
  Write-Output "Nushell $(nu --version)"

# Run test suites.
test *args:
  cargo test {{ "{{" }}args{{ "}}" }}

